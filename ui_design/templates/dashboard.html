{% extends "base.html" %}

{% block title %}Dashboard - Bird Recognition{% endblock %}

{% block extra_css %}
<style>
    .welcome-header {
        font-size: 2rem;
        color: #333;
        margin-bottom: 1.5rem;
        font-weight: 600;
        text-align: center;
    }

    .card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .card h3 {
        color: #1565c0;
        margin-bottom: 1.5rem;
        font-size: 1.6rem;
        display: flex;
        align-items: center;
    }

    .card h3::before {
        content: '';
        width: 4px;
        height: 28px;
        background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
        margin-right: 12px;
        border-radius: 2px;
    }

    .upload-zone {
        border: 2px dashed #cbd5e0;
        border-radius: 12px;
        padding: 2.5rem;
        text-align: center;
        transition: all 0.3s ease;
        background: #f8f9fa;
    }

    .upload-zone:hover {
        border-color: #1565c0;
        background: #e3f2fd;
    }

    .upload-icon {
        font-size: 4.5rem !important;
        margin-bottom: 1.5rem;
        color: #1565c0;
    }

    .file-preview {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1.2rem;
        margin-top: 1.5rem;
    }

    .preview-item {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 3px 10px rgba(0,0,0,0.12);
        transition: transform 0.2s ease;
    }

    .preview-item:hover {
        transform: translateY(-3px);
    }

    .preview-item img {
        width: 100%;
        height: 180px;
        object-fit: cover;
    }

    .preview-item .file-info {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 0.7rem;
        font-size: 0.9rem;
    }

    .preview-item .delete-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 0, 0, 0.8);
        color: white;
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        transition: background 0.3s ease;
    }

    .preview-item .delete-btn:hover {
        background: rgba(255, 0, 0, 1);
    }

    .clear-files-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 0.7rem 1.2rem;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 1.2rem;
        font-size: 1rem;
        transition: background 0.3s ease;
    }

    .clear-files-btn:hover {
        background: #c82333;
    }

    .recent-uploads {
        max-height: 600px;
        overflow-y: auto;
        padding: 0;
    }

    .upload-item {
        display: flex;
        align-items: center;
        padding: 1.2rem;
        border-bottom: 1px solid #e2e8f0;
        transition: background 0.3s ease;
    }

    .upload-item:hover {
        background: #f8f9fa;
    }

    .upload-item-icon {
        font-size: 3.5rem;
        margin-right: 1.5rem;
        color: #1565c0;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 60px;
        height: 60px;
    }

    .upload-item-thumbnail {
        margin-right: 1.5rem;
        width: 60px;
        height: 60px;
        border-radius: 4px;
        overflow: hidden;
    }

    .upload-item-details {
        flex: 1;
    }

    .upload-item-name {
        font-weight: 600;
        color: #333;
        font-size: 1.1rem;
    }

    .upload-item-meta {
        font-size: 0.95rem;
        color: #666;
        margin-top: 0.4rem;
    }

    .search-container {
        margin-bottom: 1.5rem;
    }

    .form-group {
        margin-bottom: 1.2rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.7rem;
        font-weight: 500;
        font-size: 1.1rem;
    }

    .form-control {
        width: 100%;
        padding: 0.8rem;
        border: 1px solid #cbd5e0;
        border-radius: 6px;
        font-size: 1.1rem;
    }

    .form-control:focus {
        border-color: #1565c0;
        outline: none;
        box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.2);
    }

    #imageSearchResults {
        margin-top: 2rem;
    }

    #imageSearchResults h4 {
        margin-bottom: 1.2rem;
        color: #333;
        font-size: 1.3rem;
    }
    
    .tab-container {
        margin-bottom: 2rem;
    }
    
    .tab-buttons {
        display: flex;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        justify-content: center;
    }
    
    .tab-button {
        padding: 1rem 2rem;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-weight: 600;
        color: #666;
        transition: all 0.3s ease;
        font-size: 1.2rem;
        margin: 0 0.5rem;
    }
    
    .tab-button.active {
        color: #1565c0;
        border-bottom-color: #1565c0;
    }

    .tab-button:hover:not(.active) {
        color: #2196f3;
        border-bottom-color: #bbdefb;
    }
    
    .tab-content {
        display: none;
        animation: fadeIn 0.5s;
    }
    
    .tab-content.active {
        display: block;
    }

    .btn {
        padding: 0.8rem 1.5rem;
        font-size: 1.1rem;
        font-weight: 500;
        border-radius: 6px;
        transition: all 0.3s ease;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .recent-title {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        border-left: 4px solid #1565c0;
        padding-left: 1rem;
    }

    .recent-title-icon {
        font-size: 1.5rem;
        margin-right: 0.5rem;
        color: #1565c0;
    }

    .recent-title-text {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1565c0;
    }
</style>
{% endblock %}

{% block content %}
<div class="welcome-header">
    Welcome back, {{ session.username }}! <span style="font-size: 1.8rem;">üê¶</span>
</div>

<!-- Tab Navigation -->
<div class="tab-container">
    <div class="tab-buttons">
        <button class="tab-button active" onclick="openTab('uploadTab')">Upload & Detect</button>
        <button class="tab-button" onclick="openTab('recentTab')">Recent Uploads</button>
        <button class="tab-button" onclick="openTab('searchTab')">Search Images</button>
</div>

    <!-- Upload Tab -->
    <div id="uploadTab" class="tab-content active">
<div class="card">
            <h3>ü¶ú Upload Bird Media</h3>
            <div class="upload-zone" id="uploadZone">
                <input type="file" id="file" name="file" multiple style="display: none;" accept=".jpg,.jpeg,.png,.gif,.mp4,.avi,.mov,.mp3,.wav">
                <div class="upload-icon">üìÅ</div>
                <h4 style="font-size: 1.4rem; margin-bottom: 1rem;">Choose files or drag & drop</h4>
                <p style="color: #666; margin-bottom: 1.2rem; font-size: 1.1rem;">Supports: Images (jpg, png), Videos (mp4, avi), Audio (mp3, wav)</p>
                <button type="button" class="btn" onclick="document.getElementById('file').click()">Browse Files</button>
                <p style="font-size: 0.95rem; color: #666; margin-top: 1.2rem;">üí° Tip: Click the √ó button on any file to remove it from upload</p>
        </div>

            <form id="uploadForm" style="margin-top: 1.5rem; text-align: center;">
                <button type="submit" class="btn" style="background: #1565c0; color: white; padding: 0.8rem 2rem;">Upload & Auto-Tag</button>
    </form>
            <div id="uploadResult" style="margin-top: 1.5rem;"></div>
    <div id="filePreview" class="file-preview"></div>
</div>
</div>

    <!-- Recent Uploads Tab -->
    <div id="recentTab" class="tab-content">
<div class="card">
    <h3>üìã Recent Uploads</h3>
    <div class="recent-uploads" id="recentUploads">
        <div class="upload-item">
            <div class="upload-item-icon">üñºÔ∏è</div>
            <div class="upload-item-details">
                        <div class="upload-item-name">Loading recent uploads...</div>
                        <div class="upload-item-meta">Please wait...</div>
            </div>
        </div>
    </div>
</div>
</div>

    <!-- Search Tab -->
    <div id="searchTab" class="tab-content">
        <div class="card">
            <h3>üîç Image Search</h3>
            <div class="search-container">
                <form id="imageSearchForm">
                    <div class="form-group">
                        <label for="imageQuery">Search images by species name:</label>
                        <input type="text" id="imageQuery" name="imageQuery" placeholder="Enter bird name, e.g.: Cockatoo, Kookaburra..." class="form-control">
        </div>
                    <button type="submit" class="btn" style="background: #1565c0; color: white;">Search Images</button>
                </form>
        </div>
            <div id="imageSearchResults" style="margin-top: 1.5rem; display: none;">
                <h4>Search Results</h4>
                <div id="imageResultContent" class="file-preview"></div>
    </div>
</div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Global array to store selected files
let selectedFiles = [];

// File preview functionality
function updateFilePreview() {
    const previewContainer = document.getElementById('filePreview');
    previewContainer.innerHTML = '';

    if (selectedFiles.length === 0) {
        return;
    }

    selectedFiles.forEach((file, index) => {
        const previewItem = document.createElement('div');
        previewItem.className = 'preview-item';
        previewItem.setAttribute('data-file-index', index);

        const deleteBtn = `<button class="delete-btn" onclick="removeFile(${index})" title="Remove file">√ó</button>`;

        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewItem.innerHTML = `
                    <img src="${e.target.result}" alt="${file.name}">
                    ${deleteBtn}
                    <div class="file-info">
                        <div>üì∏ ${file.name}</div>
                        <div style="font-size: 0.85rem;">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        } else if (file.type.startsWith('video/')) {
            previewItem.innerHTML = `
                <div style="background: #f0f0f0; height: 180px; display: flex; align-items: center; justify-content: center;">
                    <span style="font-size: 4rem;">üé•</span>
                </div>
                ${deleteBtn}
                <div class="file-info">
                    <div>${file.name}</div>
                    <div style="font-size: 0.85rem;">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                </div>
            `;
        } else if (file.type.startsWith('audio/')) {
            previewItem.innerHTML = `
                <div style="background: #f0f0f0; height: 180px; display: flex; align-items: center; justify-content: center;">
                    <span style="font-size: 4rem;">üéµ</span>
                </div>
                ${deleteBtn}
                <div class="file-info">
                    <div>${file.name}</div>
                    <div style="font-size: 0.85rem;">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                </div>
            `;
        }

        previewContainer.appendChild(previewItem);
    });

    // Add clear all button if there are files
    if (selectedFiles.length > 0) {
        const clearBtn = document.createElement('button');
        clearBtn.className = 'clear-files-btn';
        clearBtn.textContent = `Clear All Files (${selectedFiles.length})`;
        clearBtn.onclick = clearAllFiles;
        previewContainer.appendChild(clearBtn);
    }
}

// Remove single file
function removeFile(index) {
    selectedFiles.splice(index, 1);
    updateFilePreview();
}

// Clear all files
function clearAllFiles() {
    selectedFiles = [];
    document.getElementById('file').value = '';
    updateFilePreview();
}

// Handle file input change
document.getElementById('file').addEventListener('change', function(e) {
    const newFiles = Array.from(e.target.files);
    selectedFiles = [...selectedFiles, ...newFiles];
    updateFilePreview();
});

// Drag and drop functionality
const uploadZone = document.querySelector('.upload-zone');
const fileInput = document.getElementById('file');

uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.style.borderColor = '#1565c0';
    uploadZone.style.background = '#e3f2fd';
});

uploadZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    uploadZone.style.borderColor = '#cbd5e0';
    uploadZone.style.background = '#f8f9fa';
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.style.borderColor = '#cbd5e0';
    uploadZone.style.background = '#f8f9fa';

    if (e.dataTransfer.files.length) {
        const newFiles = Array.from(e.dataTransfer.files);
        selectedFiles = [...selectedFiles, ...newFiles];
        updateFilePreview();
    }
});

// File upload handler
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!selectedFiles.length) {
        const uploadResult = document.getElementById('uploadResult');
        uploadResult.innerHTML = '<div class="alert alert-error" style="background: #ffebee; color: #c62828; padding: 1rem; border-radius: 6px;">‚ö†Ô∏è Please select at least one file before uploading</div>';
        return;
    }

    const uploadResult = document.getElementById('uploadResult');
    // Clear previous response
    uploadResult.innerHTML = '<div class="alert alert-info" style="background: #e3f2fd; color: #0d47a1; padding: 1rem; border-radius: 6px;">üîÑ Uploading and analyzing files...</div>';

    try {
        // Use direct local upload
            const formData = new FormData();
            for (let i = 0; i < selectedFiles.length; i++) {
                formData.append('files', selectedFiles[i]);
            console.log(`Adding file to form: ${selectedFiles[i].name}`);
        }
        
        // Add default values since we've removed the corresponding input fields
        formData.append('location', 'Default Location');
        formData.append('date', new Date().toISOString().split('T')[0]);
        formData.append('notes', '');

        const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

        const result = await response.json();
        console.log('Upload response:', result);
        
        if (result.success) {
            console.log('Detected species:', result.species);
            console.log('Files:', result.files);
            
                uploadResult.innerHTML = `
                <div class="alert alert-success" style="background: #e8f5e9; color: #2e7d32; padding: 1rem; border-radius: 6px;">
                    ‚úÖ Successfully uploaded ${result.files.length} file(s)
                    ${result.species && result.species.length > 0 ? 
                      `<div style="margin-top: 0.5rem; font-weight: 500;">Detected species: ${result.species.join(', ')}</div>` : ''}
                    </div>
                `;
                
            // Create result structure
            const uploadResults = result.files.map((file) => ({
                species: file.species_detected || [],
                file: { original_filename: file.original_filename }
                }));
                
                clearAllFiles();
            updateRecentUploads(uploadResults);
            
            // Switch to Recent Uploads tab after successful upload
            setTimeout(() => {
                openTab('recentTab');
            }, 1500);
        } else {
            uploadResult.innerHTML = `<div class="alert alert-error" style="background: #ffebee; color: #c62828; padding: 1rem; border-radius: 6px;">‚ùå Upload failed: ${result.message}</div>`;
            console.error('Upload error details:', result);
        }
    } catch (error) {
        console.error('Upload error:', error);
        uploadResult.innerHTML = '<div class="alert alert-error" style="background: #ffebee; color: #c62828; padding: 1rem; border-radius: 6px;">‚ùå Upload failed. Please try again.</div>';
    }
});

// Image search handler
document.getElementById('imageSearchForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const query = document.getElementById('imageQuery').value.trim();
    
    if (!query) {
        alert('Please enter a search term');
        return;
    }
    
    try {
        const response = await fetch('/api/image-search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ query: query })
        });

        const result = await response.json();

        const imageSearchResults = document.getElementById('imageSearchResults');
        imageSearchResults.style.display = 'block';

        if (result.success && result.images.length > 0) {
            let resultsHTML = `<p style="margin-bottom: 1rem; font-size: 1.1rem;">Found ${result.images.length} matching images</p><div class="file-preview">`;

            result.images.forEach(image => {
                resultsHTML += `
                    <div class="preview-item">
                        <img src="${image.url}" alt="${image.filename}">
                        <div class="file-info">
                            <div>${image.filename}</div>
                            <div style="font-size: 0.85rem;">${image.species || 'Unknown species'}</div>
                        </div>
                    </div>
                `;
            });

            resultsHTML += '</div>';
            document.getElementById('imageResultContent').innerHTML = resultsHTML;
        } else {
            document.getElementById('imageResultContent').innerHTML = '<div style="background: #e3f2fd; color: #0d47a1; padding: 1rem; border-radius: 6px; text-align: center;">No matching images found</div>';
        }
        
        // Smooth scroll to results
        imageSearchResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } catch (error) {
        console.error('Image search error:', error);
        alert('Search failed, please try again');
    }
});

// Update recent uploads with real data
function updateRecentUploads(uploadResults = null) {
    const recentUploads = document.getElementById('recentUploads');
    
    // Always start with empty content to avoid duplicates
        recentUploads.innerHTML = '';
        
    if (uploadResults && uploadResults.length > 0) {
        // Add new uploads from the parameter
        uploadResults.forEach(result => {
            const speciesText = result.species && result.species.length > 0 
                ? result.species.join(', ') 
                : 'Unknown species';
            
            const newUpload = `
                <div class="upload-item">
                    <div class="upload-item-icon">üñºÔ∏è</div>
                    <div class="upload-item-details">
                        <div class="upload-item-name">${result.file?.original_filename || result.filename || 'Uploaded file'}</div>
                        <div class="upload-item-meta">Uploaded just now ‚Ä¢ Species: ${speciesText}</div>
                    </div>
                </div>
            `;
            recentUploads.innerHTML += newUpload;
        });
    }
    
    // Always fetch existing uploads from server to show all recent uploads
    fetchExistingUploads();
}

// Fetch existing uploads from server
async function fetchExistingUploads() {
    try {
        console.log("Fetching existing uploads from server...");
        const response = await fetch('/api/recent-uploads');
        console.log("Response status:", response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log("Received data:", data);
            
            if (data.success && data.uploads && data.uploads.length > 0) {
                console.log(`Found ${data.uploads.length} uploads`);
                const recentUploads = document.getElementById('recentUploads');
                
                // If recentUploads is empty or shows loading, clear it
                if (recentUploads.innerHTML.includes('Loading recent uploads...') || 
                    recentUploads.innerHTML.includes('Please wait...') ||
                    recentUploads.innerHTML.includes('No uploads found')) {
                    recentUploads.innerHTML = '';
                }
                
                // Add all existing uploads
                data.uploads.forEach(upload => {
                    const speciesText = upload.species && upload.species.length > 0 
                        ? upload.species.join(', ') 
                        : 'Unknown species';
                    
                    // Format the upload date
                    let uploadTime = 'Just now';
                    if (upload.uploaded_at) {
                        try {
                            const uploadDate = new Date(upload.uploaded_at);
                            uploadTime = uploadDate.toLocaleString();
                        } catch (e) {
                            console.error('Error formatting date:', e);
                        }
                    }
                    
                    // Create an image thumbnail element
                    let thumbnailElement = '';
                    if (upload.file_type === 'image') {
                        thumbnailElement = `
                            <div class="upload-item-thumbnail">
                                <img src="${upload.url}" 
                                     alt="${upload.filename}" 
                                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;"
                                     onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22><rect width=%2260%22 height=%2260%22 fill=%22%23f0f0f0%22/><text x=%2230%22 y=%2235%22 font-size=%2220%22 text-anchor=%22middle%22 fill=%22%23999%22>?</text></svg>';">
                    </div>
            `;
        } else {
                        thumbnailElement = `<div class="upload-item-icon">üñºÔ∏è</div>`;
                    }
                    
                    const uploadItem = `
                        <div class="upload-item">
                            ${thumbnailElement}
                            <div class="upload-item-details">
                                <div class="upload-item-name">${upload.filename}</div>
                                <div class="upload-item-meta">Uploaded ${uploadTime} ‚Ä¢ Species: ${speciesText}</div>
                            </div>
                    </div>
                `;
                    
                    // Add to the list if it's not already there
                    if (!recentUploads.innerHTML.includes(upload.filename)) {
                        recentUploads.innerHTML += uploadItem;
                    }
                });
                
                // If still empty after all that, show a message
                if (recentUploads.innerHTML === '') {
                    showNoUploadsMessage();
                }
        } else {
                console.log("No uploads found or data format incorrect");
                showNoUploadsMessage();
            }
        } else {
            console.error("Error response from server:", response.status);
            showNoUploadsMessage();
        }
    } catch (error) {
        console.error('Error fetching existing uploads:', error);
        showNoUploadsMessage();
    }
}

// Helper function to show no uploads message
function showNoUploadsMessage() {
    const recentUploads = document.getElementById('recentUploads');
    recentUploads.innerHTML = `
        <div class="upload-item">
            <div class="upload-item-icon">üìù</div>
            <div class="upload-item-details">
                <div class="upload-item-name">No uploads found</div>
                <div class="upload-item-meta">Start uploading to see your bird observations here</div>
            </div>
                    </div>
                `;
}

// Fetch recent uploads from server
async function fetchRecentUploads() {
    try {
        console.log("Fetching recent uploads...");
        const recentUploads = document.getElementById('recentUploads');
        recentUploads.innerHTML = `
            <div class="upload-item">
                <div class="upload-item-icon">‚åõ</div>
                <div class="upload-item-details">
                    <div class="upload-item-name">Loading recent uploads...</div>
                    <div class="upload-item-meta">Please wait...</div>
                </div>
                                </div>
        `;
        
        await fetchExistingUploads();
    } catch (error) {
        console.error('Error in fetchRecentUploads:', error);
        const recentUploads = document.getElementById('recentUploads');
        recentUploads.innerHTML = `
            <div class="upload-item">
                <div class="upload-item-icon">‚ùå</div>
                <div class="upload-item-details">
                    <div class="upload-item-name">Error loading uploads</div>
                    <div class="upload-item-meta">Please try again later</div>
                </div>
                </div>
            `;
    }
}

// Tab functionality
function openTab(tabName) {
    // Hide all tab contents
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Deactivate all tab buttons
    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(button => {
        button.classList.remove('active');
    });
    
    // Show the selected tab content
    document.getElementById(tabName).classList.add('active');
    
    // Activate the clicked tab button
    const activeButton = Array.from(tabButtons).find(button => 
        button.getAttribute('onclick').includes(tabName)
    );
    if (activeButton) activeButton.classList.add('active');
    
    // If switching to recent uploads tab, refresh the data
    if (tabName === 'recentTab') {
        fetchRecentUploads();
    }
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    // No need to load statistics since we removed them
    fetchRecentUploads();
});
</script>
{% endblock %}